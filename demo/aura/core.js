// ## Core
// Implements the mediator pattern and
// encapsulates the core functionality for this application.
// Based on the work by Addy Osmani and Nicholas Zakas.
//
// * [Patterns For Large-Scale JavaScript Application Architecture](http://addyosmani.com/largescalejavascript/)
// * [Large-scale JavaScript Application Architecture Slides](http://speakerdeck.com/u/addyosmani/p/large-scale-javascript-application-architecture)
// * [Building Large-Scale jQuery Applications](http://addyosmani.com/blog/large-scale-jquery/)
// * [Nicholas Zakas: Scalable JavaScript Application Architecture](http://www.youtube.com/watch?v=vXjVFPosQHw&feature=youtube_gdata_player)
// * [Writing Modular JavaScript: New Premium Tutorial](http://net.tutsplus.com/tutorials/javascript-ajax/writing-modular-javascript-new-premium-tutorial/)
// include 'deferred' if using zepto
define(["aura_base","aura_sandbox","aura_perms"],function(e,t,n){"use strict";function f(e,t){return t=t===undefined?"_":t,e.replace(/([A-Z])/g,t+"$1").toLowerCase()}function l(e){return e instanceof Object}var r={},i={},s=[],o=!1,u="widgets",a=0;return function(){if(typeof e===undefined)throw new Error("Base library is required");if(!e.data)throw new Error("Base library must include the data property");if(!e.data.deferred)throw new Error("Base library must include data.deferred");if(!e.data.when)throw new Error("Base library must include data.when");if(!e.dom)throw new Error("Base library must include the dom property");if(!e.dom.find)throw new Error("Base library must include dom.find");r=e}(),Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i}),Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"}),r.getWidgetsPath=function(){return u},r.log=function(e){var t=Array.prototype.slice.call(arguments,0);t[0]="["+e+"]",console.log.apply(console,t)},r.on=function(e,t,r,s){if(e===undefined||r===undefined||s===undefined)throw new Error("Channel, callback, and context must be defined");if(typeof e!="string")throw new Error("Channel must be a string");if(typeof t!="string")throw new Error("Subscriber must be a string");if(typeof r!="function")throw new Error("Callback must be a function");if(!n.validate(e,t))return;i[e]=i[e]?i[e]:[];if(e==="*")for(var o in i)i.hasOwnProperty(o)&&i[o].push({subscriber:t,callback:r.bind(s)});else i[e].push({subscriber:t,callback:r.bind(s)})},r.getEmitQueueLength=function(){return s.length},r.emit=function(e){if(e===undefined)throw new Error("Channel must be defined");if(typeof e!="string")throw new Error("Channel must be a string");if(o)return s.push(arguments),!1;var t,n,r=[].slice.call(arguments,1);if(!i[e])return!1;for(t=0;t<i[e].length;t++)if(i[e][t].callback==null)i[e].splice(t,1),t--;else try{i[e][t].callback.apply(this,r)}catch(u){console.error(u.message)}return!0},r.emptyEmitQueue=function(){var e,t,n;o=!1;for(t=0,n=s.length;t<n;t++)r.emit.apply(this,s[t]);s=[]},r.start=function(e){function c(e,n){var i=f(e),s=r.data.deferred(),o=r.getWidgetsPath(),u=require.s.contexts._.config;u.paths&&u.paths.hasOwnProperty("widgets")&&(o=u.paths.widgets);var l=o+"/"+i,c="sandbox$"+a++,h={};h[l]={sandbox:c};var p=require.config({map:h}),d=t.create(r,e);return r.getSandbox&&(d=r.getSandbox(d,e)),define(c,d),p([l+"/main"],function(e){try{e(n)}catch(t){console.error(t)}s.resolve()},function(e){if(e.requireType!=="timeout"){var t=e.requireModules&&e.requireModules[0];throw require.undef(t),e}console.warn("Could not load module "+e.requireModules),s.reject()}),s.promise()}var n=[].slice.call(arguments,1);typeof e=="string"&&n[0]!==undefined&&(e=[{channel:e,options:n[0]}]),l(e)&&!Array.isArray(e)&&(e=[e]);if(!Array.isArray(e))throw new Error("Channel must be defined as an array");var i=0,s=e.length,u=[];o=!0;for(;i<s;i++){var h=e[i];u.push(c(h.channel,h.options||{}))}r.data.when.apply($,u).done(r.emptyEmitQueue)},r.stop=function(e,t){var n=f(e);for(var s in i)if(i.hasOwnProperty(s))for(var o=0,u=i[s].length;o<u;o++)i[s][o].subscriber===e&&(i[s][o].callback=null);r.unload("widgets/"+n),t&&r.dom.find(t).children().remove()},r.unload=function(e){var t,n=require.s.contexts._.defined;for(t in n)n.hasOwnProperty(t)&&t.indexOf(e)!==-1&&require.undef(t)},r.getChannels=function(){return i},r});